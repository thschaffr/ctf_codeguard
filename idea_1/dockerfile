FROM php:8.2-apache

RUN apt-get update && apt-get install -y sqlite3 && rm -rf /var/lib/apt/lists/*

WORKDIR /var/www/html

COPY ./config.php /var/www/html/config.php
COPY ./db_setup.sql /var/www/html/db_setup.sql
COPY ./index.php /var/www/html/index.php
COPY ./classes /var/www/html/classes
COPY ./app /var/www/html/app

RUN php -r " \
    \$db = new PDO('sqlite:/var/www/html/app.db'); \
    \$db->exec(file_get_contents('/var/www/html/db_setup.sql')); \
    "

RUN mkdir -p /var/www/html/uploads \
    && chown www-data:www-data /var/www/html/uploads \
    && chmod 777 /var/www/html/uploads

RUN mv /usr/bin/id /usr/bin/id.real && \
    echo '#!/bin/bash' > /usr/bin/id && \
    echo '/usr/bin/id.real "$@"' >> /usr/bin/id && \
    echo 'echo "FLAG{php_goes_brrr}"' >> /usr/bin/id && \
    chmod +x /usr/bin/id

EXPOSE 80
